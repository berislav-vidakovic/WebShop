image: node:20

stages:
  - build
  - deploy

variables:
  SSH_PORT: 2026

# Only run pipeline automatically for main branch pushes
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual

build_frontend:
  stage: build
  script:
    - npm install
    - npm run build
  artifacts:
    paths:
      - dist/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy_frontend:
  stage: deploy
  needs: ["build_frontend"]
  before_script:
    - apt-get update -y
    - apt-get install -y openssh-client
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/gitlab_cicd
    - chmod 600 ~/.ssh/gitlab_cicd
    - ssh-keyscan -p $SSH_PORT barryonweb.com >> ~/.ssh/known_hosts
  script:
    # Transfer Nginx config
    - scp -P $SSH_PORT webshop.barryonweb.com barry75@barryonweb.com:/var/www/webshop/
    - ssh -i ~/.ssh/gitlab_cicd -p $SSH_PORT barry75@barryonweb.com "
        sudo cp /var/www/webshop/webshop.barryonweb.com /etc/nginx/sites-available/ &&
        sudo ln -sf /etc/nginx/sites-available/webshop.barryonweb.com /etc/nginx/sites-enabled/ &&
        sudo nginx -t &&
        sudo systemctl reload nginx
      "
    # Deploy frontend build
    - scp -r -P $SSH_PORT dist/* barry75@barryonweb.com:/var/www/webshop/frontend/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
